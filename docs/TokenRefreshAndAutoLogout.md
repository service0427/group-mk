# 토큰 리프레시 및 자동 로그아웃 메커니즘

본 문서는 인증 시스템의 토큰 리프레시와 로그아웃 메커니즘에 대한 설명입니다.

## 로그아웃 프로세스 동작 방식

### 개선된 로그아웃 메커니즘

로그아웃 과정에서 발생하는 404 오류를 방지하기 위해 다음과 같은 개선 사항을 적용했습니다:

1. **구독 해제 우선 처리**
   - Supabase 이벤트 리스너를 먼저 해제하여 백그라운드 작업 충돌 방지
   - 세션 상태 변경에 대한
   ```tsx
   try {
       // 구독 해제 시도 - 이벤트 핸들러에 빈 함수 전달
       const { data } = supabase.auth.onAuthStateChange(() => {});
       if (data?.subscription) {
           data.subscription.unsubscribe();
       }
   } catch (e) {
       // 구독 해제 실패 무시
   }
   ```

2. **상태 정리 순서 최적화**
   - 클라이언트 측 상태를 먼저 초기화 (`setAuth(undefined)`, `setCurrentUser(null)`)
   - 로그아웃 플래그 설정 (localStorage, sessionStorage)
   - Supabase 관련 항목 제거 (localStorage에서 sb- 접두사 항목)
   - 인증 관련 쿠키 정리

3. **페이지 전환 방식 개선**
   - `window.location.hash` 대신 `window.location.href` 사용
   - 캐시 방지를 위한 타임스탬프 파라미터 추가
   - `force=true` 플래그를 통한 강제 새로고침 적용
   - fallback 쿠키 설정으로 다중 보호 계층 적용

4. **비동기 세션 종료**
   - Supabase 세션 종료(`supabase.auth.signOut()`)를 UI 리디렉션 후 백그라운드에서 처리
   - setTimeout을 통한 실행 지연 (50ms)

5. **오류 복구 메커니즘**
   - 로그아웃 실패 시 여러 단계의 대체 메커니즘 구현
   - localStorage, sessionStorage, 쿠키의 완전 초기화
   - 강제 페이지 리로드를 통한 최종 복구

## 여러 보호 계층 (Defense in Depth)

로그아웃 프로세스의 안정성을 보장하기 위해 여러 보호 계층을 구현했습니다:

1. **자동 세션 재시도**
   - fallback_logout 쿠키를 통한 로그아웃 상태 유지
   - 페이지 리로드 후에도 로그아웃 상태 인식 가능

2. **타임스탬프 기반 정리**
   - 로그아웃 시점 기록으로 타이밍 관련 오류 방지
   - 특정 시간 내에 로그아웃 관련 작업 완료 보장

3. **메타 태그 표식**
   - 로그아웃 상태를 위한 메타 태그 추가
   - 페이지 간 상태 전이 추적 지원

4. **경로 매핑 개선**
   - _routes.json에 모든 경로 명시적 정의
   - SPA 라우팅을 위한 모든 경로 index.html로 리다이렉션

## 인증 흐름 개선

### 토큰 갱신 메커니즘

1. **토큰 수명 확인**
   - JWT 토큰 디코딩을 통한 만료 시간 확인
   - 만료 10분 전 또는 절반 시점에 자동 갱신

2. **캐싱 최적화**
   - 사용자 정보 캐싱으로 중복 요청 최소화
   - 세션 스토리지를 활용한 빠른 상태 복원

3. **비활성 로그아웃**
   - 일정 시간(30분) 사용자 비활성 시 자동 로그아웃
   - 마우스, 키보드, 스크롤 등 사용자 활동 모니터링

## 로그아웃 관련 문제 해결 가이드

로그아웃 관련 문제가 발생할 경우 다음을 확인하세요:

1. **브라우저 캐시 확인**
   - 개발자 도구 > Application > Storage > Clear Site Data
   - 모든 브라우저 캐시 및 쿠키 삭제

2. **로컬 스토리지 확인**
   - 'sb-'로 시작하는 항목이 남아있는지 확인
   - 'auth_redirect', 'logout_timestamp' 항목 확인

3. **CloudFlare 캐싱 확인**
   - _headers 파일에 캐시 방지 지시자 적용 확인
   - _routes.json 파일에 모든 경로가 올바르게 매핑되었는지 확인

4. **네트워크 요청 분석**
   - 로그아웃 과정에서 발생하는 네트워크 요청 확인
   - 404 오류가 발생하는 시점과 경로 확인

## 참고 사항

- 해시 라우팅(`#`)과 슬래시(`/`) 통일성을 유지해야 함
- AuthMiddleware에서 경로 비교 시 정규화된 경로 사용 
- CloudFlare 환경에서는 _routes.json이 라우팅의 핵심 역할