# 단건형(Per-Unit) 캠페인 설계 문서

## 1. 개요

단건형 캠페인은 건별 단가를 기반으로 하는 새로운 캠페인 유형입니다. 블로그 배포나 가구매 형태의 서비스에 적합하며, 보장형 캠페인의 견적/협상 시스템과 정산 체계를 기반으로 설계되었습니다.

### 1.1 주요 특징
- **건별 단가 방식**: "300건 이상부터 가능, 건당 1,000원" 형태의 가격 구조
- **최소 수량 제한**: 캠페인별로 최소 구매 수량 설정
- **실시간 금액 계산**: 수량 입력 시 자동으로 총 금액 계산
- **협상 시스템**: 보장형과 동일한 가격 협상 프로세스
- **작업 실적 관리**: 건별 완료 실적 추적 및 검증
- **정산 시스템**: 실제 완료된 건수에 따른 정산

### 1.2 타입 구조
```
캠페인 타입:
├── 일반형 (standard) - 즉시 구매형
├── 보장형 (guarantee) - 목표 달성 보장형
└── 단건형 (per-unit) - 건별 단가형 [NEW]
```

## 2. 데이터베이스 설계

### 2.1 주요 테이블 구조

#### 2.1.1 단건형 캠페인 정보 (per_unit_campaigns)
기본 캠페인 정보와 단건형 특화 설정을 관리합니다.

```sql
- campaign_id: 기본 캠페인 참조
- min_quantity: 최소 구매 수량
- unit_price: 건당 단가
- max_quantity: 최대 구매 수량 (선택)
- is_negotiable: 가격 협상 가능 여부
- work_period: 작업 기간 (일)
```

#### 2.1.2 견적 요청 (per_unit_slot_requests)
사용자의 견적 요청과 협상 상태를 관리합니다.

```sql
- requested_quantity: 요청 수량
- requested_unit_price: 희망 단가
- suggested_unit_price: 총판 제안 단가
- status: 요청 상태
```

#### 2.1.3 협상 메시지 (per_unit_negotiations)
사용자와 총판 간의 협상 내역을 기록합니다.

#### 2.1.4 단건형 슬롯 (per_unit_slots)
구매 확정된 단건형 서비스의 진행 상태를 관리합니다.

```sql
- quantity: 구매 수량
- unit_price: 확정 단가
- completed_quantity: 완료된 수량
- status: 진행 상태
```

#### 2.1.5 작업 실적 (per_unit_work_logs)
일별 작업 완료 실적과 증빙 자료를 관리합니다.

#### 2.1.6 문의/환불 시스템
- per_unit_inquiries: 1:1 문의
- per_unit_inquiry_messages: 문의 메시지
- per_unit_refund_requests: 환불 요청
- per_unit_settlements: 정산 내역

### 2.2 테이블 관계도

```
campaigns (1) ─── (1) per_unit_campaigns ─┬─ (N) per_unit_slot_requests ─── (1) per_unit_slots
                                         │              │                              │
                                         │              └─── (N) negotiations         ├─── (N) work_logs
                                         │                                           ├─── (N) inquiries
                                         └──────────────────────────────────────── ├─── (N) refunds
                                                                                    └─── (N) settlements
```

## 3. 주요 프로세스

### 3.1 캠페인 등록 프로세스
1. 총판/운영자가 캠페인 생성
2. 캠페인 타입을 '단건형'으로 선택
3. 최소 수량, 건당 단가, 작업 기간 등 설정
4. 협상 가능 여부 및 가격 범위 설정
5. 운영자 승인 후 활성화

### 3.2 견적/구매 프로세스
1. **견적 요청**
   - 광고주가 원하는 수량과 희망 단가 입력
   - 최소 수량 미달 시 경고 메시지 표시
   - 견적 요청서 생성 (per_unit_slot_requests)

2. **협상 단계**
   - 총판이 견적 확인 및 가격 제안
   - 실시간 메시지로 조건 협의
   - 최종 합의 도달

3. **구매 확정**
   - 합의된 조건으로 슬롯 생성
   - 총 금액 = 수량 × 단가
   - 사용자 잔액에서 차감
   - 홀딩 금액 설정

### 3.3 작업 진행 프로세스
1. **작업 시작**
   - 총판 승인 후 작업 시작
   - 일별 작업 계획 수립

2. **작업 실적 등록**
   - 일별 완료 건수 입력
   - 작업 URL 및 스크린샷 첨부
   - 누적 진행률 자동 계산

3. **검증 및 승인**
   - 광고주/운영자의 실적 검증
   - 이상 없을 시 승인 처리

### 3.4 정산 프로세스
1. **일별 정산**
   - 승인된 작업 실적에 대한 정산
   - 완료 건수 × 단가로 계산

2. **최종 정산**
   - 전체 작업 완료 시 최종 정산
   - 미완료 건수에 대한 환불 처리

### 3.5 환불 프로세스
1. **환불 요청**
   - 미완료 건수 자동 계산
   - 환불 사유 및 증빙 제출

2. **환불 심사**
   - 운영자 검토 및 승인
   - 부분/전체 환불 처리

## 4. UI/UX 설계

### 4.1 캠페인 등록 화면
```
[캠페인 타입 선택]
○ 일반형 - 즉시 구매 가능한 서비스
○ 보장형 - 목표 달성을 보장하는 서비스  
● 단건형 - 건별 단가 기반 서비스

[단건형 설정]
최소 구매 수량: [300] 건
건당 단가: [1,000] 원
최대 구매 수량: [10000] 건 (선택)
작업 기간: [30] 일
□ 가격 협상 가능
  └─ 최소 단가: [800] 원
  └─ 최대 단가: [1,200] 원
```

### 4.2 구매 화면
```
[수량 입력]
구매 수량: [___] 건
━━━━━━━━━━━━━━━━━━
최소 수량: 300건
건당 단가: 1,000원
━━━━━━━━━━━━━━━━━━
총 금액: 0원 (실시간 계산)

* 최소 300건 이상부터 신청 가능합니다.
```

### 4.3 진행 현황 화면
```
[작업 진행률]
전체: 1,000건
완료: 450건 (45%)
잔여: 550건

[일별 실적]
2025-07-06: 50건 ✓
2025-07-07: 100건 ✓
2025-07-08: 80건 (검토중)
...
```

## 5. 검증 규칙

### 5.1 수량 검증
- 최소 수량 이상 입력 필수
- 최대 수량 초과 불가 (설정된 경우)
- 정수값만 허용

### 5.2 가격 검증
- 협상 가격은 설정된 범위 내에서만 가능
- 단가는 0보다 커야 함

### 5.3 작업 실적 검증
- 일일 완료 건수는 전체 수량을 초과할 수 없음
- 작업 증빙 자료 필수 첨부
- 작업 기간 내 완료 필수

## 6. 보안 및 권한

### 6.1 역할별 권한
- **광고주**: 견적 요청, 구매, 실적 확인
- **총판**: 캠페인 생성, 견적 응대, 작업 실적 등록
- **운영자**: 전체 관리, 승인/반려, 환불 처리

### 6.2 데이터 보안
- Row Level Security(RLS)로 데이터 격리
- 민감 정보 암호화
- 작업 증빙 자료 안전한 저장

## 7. 성능 최적화

### 7.1 인덱스 설계
- campaign_id, user_id, distributor_id에 인덱스
- status 필드에 부분 인덱스
- created_at에 타임스탬프 인덱스

### 7.2 쿼리 최적화
- 작업 실적 조회 시 날짜 범위 제한
- 대량 데이터는 페이지네이션 적용
- 집계 데이터는 materialized view 활용

## 8. 향후 확장 계획

### 8.1 단기 계획
- 자동 견적 시스템
- AI 기반 가격 추천
- 실시간 알림 강화

### 8.2 장기 계획
- API 개방으로 외부 연동
- 블록체인 기반 작업 증명
- 국제화 지원